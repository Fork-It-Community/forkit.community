---
import MainLayout from "@/layouts/MainLayout.astro";
import ImageBackgroundHero from "@/components/ImageBackgroundHero/index.astro";
import { getEventDisplayDate, getUpcomingMajorEvent } from "@/lib/events";
import { getPodcastsEpisodesCollection } from "@/lib/podcasts";
import { Logo } from "@/components/Logo";
import { Image } from "astro:assets";
import defaultImage from "@/assets/images/events.jpeg";
import aboutBackground from "@/assets/images/about.jpg";
import afterMovieRouen2024VideoThumbnail from "@/assets/images/after-movie-rouen-2024-video-thumbnail.jpg";
import dayjs from "dayjs";
import { MdArrowForward, MdEvent } from "react-icons/md";
import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";
import JoinTheCommunity from "@/components/JoinTheCommunity/index.astro";
import { match } from "ts-pattern";
import { getUpcomingEvents } from "@/lib/events";
import SEO from "@/components/SEO/index.astro";
import { HOME_CONFIG } from "@/content/home";
import { getEntries } from "astro:content";
import PartnersBlock from "@/components/PartnersBlock/index.astro";

const upcomingMajorEvent = await getUpcomingMajorEvent();
const upcomingEvents = (await getUpcomingEvents())
  .filter(
    (event) =>
      event.id !== upcomingMajorEvent?.id && event.data.status !== "cancelled",
  )
  .slice(0, 3);
const podcasts = await getPodcastsEpisodesCollection();
const partners = await getEntries<"partners">(
  (HOME_CONFIG.partners ?? []).map((partner) => ({
    collection: "partners",
    id: partner,
  })),
);
---

<MainLayout>
  <SEO slot="seo" />
  <!-- HERO -->
  <ImageBackgroundHero
    src={upcomingMajorEvent?.data?.image?.src ?? defaultImage}
    alt={upcomingMajorEvent?.data?.image?.alt ?? ""}
    blur
  />
  <div class="mx-auto w-full max-w-screen-xl px-4">
    <div class="flex w-full items-center justify-center pb-4 pt-20 md:hidden">
      <Logo className="w-48" />
    </div>
    <div
      class="relative flex w-full flex-col items-center gap-8 py-16 sm:flex-row sm:py-[12vh] md:px-8 xl:gap-12"
    >
      <div class="flex w-full flex-1 flex-col gap-16 sm:gap-8">
        <div class="flex flex-col gap-4">
          <h1
            class="text-balance text-center font-heading text-4xl font-medium uppercase 2xs:text-5xl xs:text-6xl sm:text-left sm:text-5xl xl:text-6xl"
          >
            Global<br /> Developer<br />
            <span class="text-primary">Community</span>
          </h1>
          {
            !upcomingMajorEvent && (
              <p class="text-balance text-center sm:text-left">
                <strong> Fork it! Communityâ€™s</strong>{" "}
                <span class="opacity-60">
                  mission is to share computer science knowledge through
                  worldwide events.
                </span>
              </p>
            )
          }
        </div>

        <!-- Next Events -->
        <div class="flex flex-col gap-10 sm:gap-8">
          {
            !upcomingMajorEvent && (
              <div class="flex w-full items-center justify-center sm:justify-start">
                <a
                  href="/events"
                  class={cn(buttonVariants(), "gap-2 sm:max-w-56")}
                >
                  Discover all events
                  <MdArrowForward className="group-hover:translate-x-1 transition" />
                </a>
              </div>
            )
          }
          {
            !!upcomingMajorEvent && (
              <a
                href={`/events/${upcomingMajorEvent.id}`}
                class={cn(
                  "group relative z-10 flex flex-col gap-3",
                  "max-sm:overflow-hidden max-sm:rounded-lg max-sm:bg-background max-sm:p-6 max-sm:shadow-xl",
                )}
              >
                {!!upcomingMajorEvent.data.image?.src && (
                  <div class="pointer-events-none absolute bottom-0 left-0 right-0 top-0 -z-10 overflow-hidden sm:hidden">
                    <Image
                      src={upcomingMajorEvent.data.image.src}
                      alt=""
                      class={cn(
                        "absolute size-full bg-white/20 object-cover object-center transition duration-500 group-hover:scale-110",
                      )}
                      width={600}
                    />
                    <div class="absolute size-full bg-gradient-to-r from-black/90 to-black/0" />
                    <div
                      class="absolute h-full w-full"
                      style={{
                        backdropFilter: "blur(32px)",
                        maskImage:
                          "linear-gradient(90deg, black 30%, transparent 70%)",
                      }}
                    />
                  </div>
                )}
                <div class="flex flex-col gap-1">
                  <h2 class="font-heading text-2xs uppercase tracking-widest opacity-60">
                    Next
                    {match(upcomingMajorEvent.data.type)
                      .with("event", () => "Full Day Event")
                      .with("meetup", () => "Community Meetup")
                      .exhaustive()}
                  </h2>
                  <div class="flex flex-col">
                    <div class="font-heading text-lg font-medium sm:text-2xl">
                      {dayjs(upcomingMajorEvent.data.date).format(
                        "MMMM DD, YYYY",
                      )}
                    </div>
                    <div class="-mt-1 font-heading text-sm opacity-60 transition group-hover:text-primary group-hover:opacity-100 sm:text-lg">
                      {upcomingMajorEvent.data.city},{" "}
                      {upcomingMajorEvent.data.country}
                    </div>
                  </div>
                </div>
                <span class={cn(buttonVariants(), "gap-2 sm:max-w-56")}>
                  {upcomingMajorEvent.data.tickets
                    ? "Tickets available"
                    : "Discover Event"}
                  <MdArrowForward className="group-hover:translate-x-1 transition" />
                </span>
              </a>
            )
          }

          {
            !!upcomingEvents.length && (
              <div class="flex flex-col gap-6 px-6 sm:gap-3 sm:px-0">
                {upcomingEvents.map((event) => (
                  <a href={`/events/${event.id}`} class="group flex gap-2">
                    <MdEvent className="opacity-40 group-hover:opacity-100 transition size-4 mt-0.5" />
                    <div class="flex flex-col">
                      <div class="font-heading font-medium tracking-wide opacity-80 transition group-hover:opacity-100 sm:text-sm">
                        {getEventDisplayDate(event)}
                      </div>
                      <div class="text-xs tracking-wide opacity-60 transition group-hover:text-primary group-hover:opacity-100">
                        {event.data.city}, {event.data.country}
                      </div>
                    </div>
                  </a>
                ))}
              </div>
            )
          }
        </div>
      </div>

      <div
        class="forkit-image-mask relative -mx-6 flex-[1.5] max-sm:hidden sm:mx-0"
      >
        <Image
          class="aspect-[3/2] w-full bg-background object-cover text-white/40"
          src={upcomingMajorEvent?.data?.image?.src ?? defaultImage}
          alt={upcomingMajorEvent?.data?.image?.alt ??
            "Speaker giving a tech talk in from of attendees"}
          width={480}
          height={320}
        />
      </div>
    </div>
  </div>

  <!-- JOIN COMMUNITY -->
  <JoinTheCommunity />

  <!-- PODCASTS -->
  <div class="mx-auto w-full max-w-screen-lg px-4 py-24">
    <div>
      <h2>Podcasts</h2>
      <ul>
        {
          podcasts.map((podcast) => (
            <li>
              <a href={`/podcasts/${podcast.id}`}>{podcast.data.title}</a>
            </li>
          ))
        }
      </ul>
    </div>
  </div>

  <!-- ABOUT -->
  <div class="relative overflow-hidden py-16 sm:py-40">
    <Image
      alt=""
      class="absolute inset-0 h-full w-full -scale-x-100 object-cover mix-blend-color-dodge grayscale"
      src={aboutBackground}
      width={1200}
    />
    <div
      class="absolute inset-0 bg-gradient-to-br from-black/70 via-black/60 to-black/0"
    >
    </div>
    <div
      class="absolute inset-0 h-full w-full"
      style={{
        backdropFilter: "blur(64px)",
        maskImage: "linear-gradient(90deg, black 30%, transparent 70%)",
      }}
    >
    </div>
    <div
      class="relative mx-auto flex max-w-screen-lg flex-col items-center justify-center gap-8 md:flex-row md:px-4 xl:justify-normal"
    >
      <div class="relative flex w-full flex-1 flex-col gap-4 px-6 md:px-0">
        <h2
          class="text-balance font-heading text-3xl font-medium uppercase tracking-wide"
        >
          What is Fork&nbsp;it! Community?
        </h2>
        <p class="bold max-w-[50ch] text-balance text-sm opacity-60">
          Fork it! is a global tech community where real people share honest
          feedback, real-life experiences, and authentic stories.
        </p>

        <a
          href="/about"
          class={cn(buttonVariants(), "group gap-2 xs:max-w-44 mt-4")}
        >
          About Fork it!
          <MdArrowForward className="transition group-hover:translate-x-1" />
        </a>
      </div>
      <div class="relative aspect-[1134/640] w-full min-w-0 flex-1">
        <a href="https://www.youtube.com/watch?v=HLGnkpZ-Q1Q" target="_blank">
          <Image
            alt="Fork it! Rouen 2024 After Movie"
            class="object-cover sm:rounded-lg"
            src={afterMovieRouen2024VideoThumbnail}
            width={1134}
            height={640}
          />
        </a>
      </div>
    </div>
  </div>

  <!-- PARTNERS -->

  {
    !!partners.length && (
      <div class="px-4">
        <PartnersBlock partners={partners} />
      </div>
    )
  }
</MainLayout>
